"use client";

import { useEffect, useState } from "react";
import { useSession } from "next-auth/react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { PageHeader } from "@/components/common";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { 
  TrendingUp, 
  Package, 
  Truck, 
  DollarSign, 
  Calendar,
  BarChart2,
  Search,
  RefreshCcw,
  ShieldAlert,
  Settings
} from "lucide-react";

// ============================================================================
// Types
// ============================================================================

interface KPISettings {
  partners: {
    [key: string]: {
      supplyPrice: number;
      costPrice: number;
      enabled: boolean;
    };
  };
  marginFormula: string;
  vatRate: number;
  commissionRate: number;
}

interface PartnerStats {
  partner: string;
  count: number;
  quantity: number;
  basePrice: number;
  shippingFee: number;
  supplyPrice: number;
  vat: number;
  totalWithVat: number;
  cost: number;
  commission: number;
  margin: number;
}

interface TotalsStats {
  count: number;
  quantity: number;
  basePrice: number;
  shippingFee: number;
  supplyPrice: number;
  vat: number;
  totalWithVat: number;
  cost: number;
  commission: number;
  margin: number;
}

interface DashboardData {
  dateRange: {
    startDate: string;
    endDate: string;
    year: number;
  };
  today: {
    byPartner: PartnerStats[];
    totals: TotalsStats;
  };
  month: {
    byPartner: PartnerStats[];
    totals: TotalsStats;
  };
  lastMonth: TotalsStats;
  year: {
    byPartner: PartnerStats[];
    totals: TotalsStats;
    productSales: Record<string, number>;
  };
  priceInfo: {
    supplyPricePerUnit: number;
    costPerUnit: number;
    vatRate: number;
    commissionRate: number;
  };
}

// ============================================================================
// Helper Functions
// ============================================================================

const formatNumber = (num: number): string => {
  return new Intl.NumberFormat("ko-KR").format(num);
};

const formatCurrency = (num: number): string => {
  return `${formatNumber(num)}ì›`;
};

// ============================================================================
// Components
// ============================================================================

// ì¼ ë§¤ì¶œ ì¹´ë“œ (í˜‘ë ¥ì‚¬ë³„)
function DailySalesCard({ 
  title, 
  data, 
  totals,
  icon: Icon,
  bgColor = "bg-gradient-to-br from-blue-50 to-indigo-50",
  borderColor = "border-blue-300",
  excludeRocketGrowth = false
}: { 
  title: string; 
  data: PartnerStats[];
  totals: TotalsStats;
  icon: React.ElementType;
  bgColor?: string;
  borderColor?: string;
  excludeRocketGrowth?: boolean;
}) {
  const filteredData = excludeRocketGrowth 
    ? data.filter(p => p.partner !== "ë¡œì¼“ê·¸ë¡œìŠ¤")
    : data;
  
  const displayTotals = excludeRocketGrowth
    ? {
        ...totals,
        totalWithVat: totals.totalWithVat - (data.find(p => p.partner === "ë¡œì¼“ê·¸ë¡œìŠ¤")?.totalWithVat || 0)
      }
    : totals;
  
  return (
    <Card className={`${bgColor} ${borderColor} border shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1`}>
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle className="text-sm font-semibold flex items-center gap-2 text-gray-700">
            <div className="p-2 bg-white rounded-lg shadow-sm">
              <Icon className="h-5 w-5 text-blue-600" />
            </div>
            <span>{title}</span>
          </CardTitle>
        </div>
      </CardHeader>
      <CardContent className="space-y-2">
        {filteredData.map(p => (
          <div key={p.partner} className="flex justify-between items-center py-1 px-2 rounded hover:bg-white/50 transition-colors">
            <span className="text-sm text-gray-600">{p.partner}</span>
            <span className="font-semibold text-blue-700">{formatCurrency(p.totalWithVat)}</span>
          </div>
        ))}
        <div className="border-t-2 border-blue-200 pt-3 mt-3 flex justify-between items-center bg-white/60 p-3 rounded-lg">
          <span className="font-bold text-gray-800">í•©ê³„ê¸ˆì•¡</span>
          <span className="font-bold text-xl text-blue-600">{formatCurrency(displayTotals.totalWithVat)}</span>
        </div>
        <p className="text-xs text-gray-500 text-center italic">(ë¶€ê°€ì„¸í¬í•¨ ê¸ˆì•¡ ì ìš©)</p>
      </CardContent>
    </Card>
  );
}

// ì£¼ë¬¸ ê±´ìˆ˜ ì¹´ë“œ
function OrderCountCard({ 
  title, 
  data, 
  totals 
}: { 
  title: string; 
  data: PartnerStats[];
  totals: TotalsStats;
}) {
  return (
    <Card className="bg-gradient-to-br from-purple-50 to-pink-50 border-purple-300 border shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle className="text-sm font-semibold flex items-center gap-2 text-gray-700">
            <div className="p-2 bg-white rounded-lg shadow-sm">
              <Package className="h-5 w-5 text-purple-600" />
            </div>
            <span>{title}</span>
          </CardTitle>
        </div>
      </CardHeader>
      <CardContent className="space-y-2">
        {data.map(p => (
          <div key={p.partner} className="flex justify-between items-center py-1 px-2 rounded hover:bg-white/50 transition-colors">
            <span className="text-sm text-gray-600">{p.partner}</span>
            <span className="font-semibold text-purple-700">{formatNumber(p.count)}</span>
          </div>
        ))}
        <div className="border-t-2 border-purple-200 pt-3 mt-3 flex justify-between items-center bg-white/60 p-3 rounded-lg">
          <span className="font-bold text-gray-800">ì¼ëˆ„ê³„</span>
          <span className="font-bold text-xl text-purple-600">{formatNumber(totals.count)}</span>
        </div>
      </CardContent>
    </Card>
  );
}

// ê³µê¸‰ê°€ ì¹´ë“œ
function SupplyPriceCard({ 
  title, 
  data, 
  totals,
  excludeRocketGrowth = false
}: { 
  title: string; 
  data: PartnerStats[];
  totals: TotalsStats;
  excludeRocketGrowth?: boolean;
}) {
  const filteredData = excludeRocketGrowth 
    ? data.filter(p => p.partner !== "ë¡œì¼“ê·¸ë¡œìŠ¤")
    : data;
  
  const rocketGrowthData = data.find(p => p.partner === "ë¡œì¼“ê·¸ë¡œìŠ¤");
  const displayTotals = excludeRocketGrowth && rocketGrowthData
    ? {
        ...totals,
        supplyPrice: totals.supplyPrice - rocketGrowthData.supplyPrice,
        totalWithVat: totals.totalWithVat - rocketGrowthData.totalWithVat
      }
    : totals;
  
  return (
    <Card className="bg-gradient-to-br from-emerald-50 to-teal-50 border-emerald-300 border shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle className="text-sm font-semibold flex items-center gap-2 text-gray-700">
            <div className="p-2 bg-white rounded-lg shadow-sm">
              <DollarSign className="h-5 w-5 text-emerald-600" />
            </div>
            <span>{title}</span>
          </CardTitle>
        </div>
      </CardHeader>
      <CardContent className="space-y-2">
        {filteredData.map(p => (
          <div key={p.partner} className="flex justify-between items-center py-1 px-2 rounded hover:bg-white/50 transition-colors">
            <span className="text-sm text-gray-600">{p.partner}</span>
            <span className="font-semibold text-emerald-700">{formatCurrency(p.supplyPrice)}</span>
          </div>
        ))}
        <p className="text-xs text-gray-500 text-center italic mt-2">(ë³¸ì‚¬: 45,000ì›/ê°œ, ê·¸ë¡œíŠ¸Â·í•´í”¼í¬ì¦ˆÂ·ìŠ¤ëª°ë‹·: 99,000ì›/ê°œ)</p>
        <div className="border-t-2 border-emerald-200 pt-3 mt-3 flex justify-between items-center bg-white/60 p-3 rounded-lg">
          <span className="font-bold text-gray-800">í•©ê³„ ê¸ˆì•¡</span>
          <span className="font-bold text-xl text-emerald-600">{formatCurrency(displayTotals.totalWithVat)}</span>
        </div>
      </CardContent>
    </Card>
  );
}

// ë°°ì†¡ë¹„ ì¹´ë“œ
function ShippingFeeCard({ 
  title, 
  data, 
  totals,
  excludeRocketGrowth = false
}: { 
  title: string; 
  data: PartnerStats[];
  totals: TotalsStats;
  excludeRocketGrowth?: boolean;
}) {
  const filteredData = excludeRocketGrowth 
    ? data.filter(p => p.partner !== "ë¡œì¼“ê·¸ë¡œìŠ¤")
    : data;
  
  const rocketGrowthData = data.find(p => p.partner === "ë¡œì¼“ê·¸ë¡œìŠ¤");
  const displayTotals = excludeRocketGrowth && rocketGrowthData
    ? {
        ...totals,
        shippingFee: totals.shippingFee - rocketGrowthData.shippingFee
      }
    : totals;
  
  return (
    <Card className="bg-gradient-to-br from-orange-50 to-amber-50 border-orange-300 border shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle className="text-sm font-semibold flex items-center gap-2 text-gray-700">
            <div className="p-2 bg-white rounded-lg shadow-sm">
              <Truck className="h-5 w-5 text-orange-600" />
            </div>
            <span>{title}</span>
          </CardTitle>
        </div>
      </CardHeader>
      <CardContent className="space-y-2">
        {filteredData.map(p => (
          <div key={p.partner} className="flex justify-between items-center py-1 px-2 rounded hover:bg-white/50 transition-colors">
            <span className="text-sm text-gray-600">{p.partner}</span>
            <span className="font-semibold text-orange-700">{formatCurrency(p.shippingFee)}</span>
          </div>
        ))}
        <div className="border-t-2 border-orange-200 pt-3 mt-3 flex justify-between items-center bg-white/60 p-3 rounded-lg">
          <span className="font-bold text-gray-800">í•©ê³„ ê¸ˆì•¡</span>
          <span className="font-bold text-xl text-orange-600">{formatCurrency(displayTotals.shippingFee)}</span>
        </div>
      </CardContent>
    </Card>
  );
}

// ë§ˆì§„ê¸ˆì•¡ ì¹´ë“œ
function MarginCard({ 
  title, 
  totals 
}: { 
  title: string; 
  totals: TotalsStats;
}) {
  return (
    <Card className="bg-gradient-to-br from-green-50 to-emerald-50 border-green-300 border shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle className="text-sm font-semibold flex items-center gap-2 text-gray-700">
            <div className="p-2 bg-white rounded-lg shadow-sm">
              <TrendingUp className="h-5 w-5 text-green-600" />
            </div>
            <span>{title}</span>
          </CardTitle>
        </div>
      </CardHeader>
      <CardContent className="space-y-3">
        <div className="flex justify-between items-center bg-white/60 p-4 rounded-lg">
          <span className="font-bold text-gray-800">í•©ê³„ê¸ˆì•¡</span>
          <span className="font-bold text-2xl text-green-600">{formatCurrency(totals.margin)}</span>
        </div>
        <p className="text-xs text-gray-500 text-center italic">(ë¶€ê°€ì„¸ ì œì™¸ ê¸ˆì•¡ ì ìš©)</p>
      </CardContent>
    </Card>
  );
}

// ì „ì›” ê¸ˆì•¡ ì¹´ë“œ
function LastMonthCard({ data }: { data: TotalsStats }) {
  return (
    <Card className="bg-gradient-to-br from-slate-50 to-gray-100 border-slate-300 border shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle className="text-sm font-semibold flex items-center gap-2 text-gray-700">
            <div className="p-2 bg-white rounded-lg shadow-sm">
              <Calendar className="h-5 w-5 text-slate-600" />
            </div>
            <span>ì „ì›” ê¸ˆì•¡</span>
          </CardTitle>
        </div>
      </CardHeader>
      <CardContent>
        <div className="space-y-2 bg-white/60 p-3 rounded-lg">
          <div className="flex justify-between text-sm">
            <span className="text-gray-600">ê³µê¸‰ê°€</span>
            <span className="font-semibold text-gray-800">{formatCurrency(data.supplyPrice)}</span>
          </div>
          <div className="flex justify-between text-sm">
            <span className="text-gray-600">ë¶€ê°€ì„¸</span>
            <span className="font-semibold text-gray-800">{formatCurrency(data.vat)}</span>
          </div>
          <div className="flex justify-between text-sm">
            <span className="text-gray-600">í•©ê³„</span>
            <span className="font-semibold text-gray-800">{formatCurrency(data.totalWithVat)}</span>
          </div>
          <div className="flex justify-between text-sm">
            <span className="text-gray-600">ì›ê°€</span>
            <span className="font-semibold text-gray-800">{formatCurrency(data.cost)}</span>
          </div>
          <div className="flex justify-between text-sm">
            <span className="text-gray-600">ë°°ì†¡ë¹„</span>
            <span className="font-semibold text-gray-800">{formatCurrency(data.shippingFee)}</span>
          </div>
          <div className="flex justify-between font-bold text-lg border-t-2 border-slate-300 pt-2 mt-2">
            <span className="text-gray-800">ë§ˆì§„</span>
            <span className="text-green-600">{formatCurrency(data.margin)}</span>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}

// ì—°ë„ ëˆ„ì  ê¸ˆì•¡ ì¹´ë“œ
function YearAccumulatedCard({ 
  totals, 
  productSales,
  year
}: { 
  totals: TotalsStats;
  productSales: Record<string, number>;
  year: number;
}) {
  const totalProducts = Object.values(productSales).reduce((a, b) => a + b, 0);

  return (
    <Card className="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 border-indigo-300 border shadow-lg hover:shadow-xl transition-all duration-300 col-span-2 transform hover:-translate-y-1">
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle className="text-sm font-semibold flex items-center gap-2 text-gray-700">
            <div className="p-2 bg-white rounded-lg shadow-sm">
              <BarChart2 className="h-5 w-5 text-indigo-600" />
            </div>
            <span>{year}ë…„ ëˆ„ì  ê¸ˆì•¡</span>
          </CardTitle>
        </div>
      </CardHeader>
      <CardContent>
        <div className="grid grid-cols-2 gap-6">
          {/* ê¸ˆì•¡ ì •ë³´ */}
          <div className="bg-white/60 p-4 rounded-lg">
            <p className="font-bold mb-3 text-indigo-700 flex items-center gap-2">
              <DollarSign className="h-4 w-4" />
              ê³µê¸‰ê°€Â·ë¶€ê°€ì„¸Â·í•©ê³„Â·ì›ê°€Â·ë°°ì†¡ë¹„Â·ë§ˆì§„
            </p>
            <div className="space-y-2">
              <div className="flex justify-between text-sm">
                <span className="text-gray-600">ê³µê¸‰ê°€</span>
                <span className="font-semibold text-gray-800">{formatCurrency(totals.supplyPrice)}</span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-gray-600">ë¶€ê°€ì„¸</span>
                <span className="font-semibold text-gray-800">{formatCurrency(totals.vat)}</span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-gray-600">í•©ê³„</span>
                <span className="font-semibold text-gray-800">{formatCurrency(totals.totalWithVat)}</span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-gray-600">ì›ê°€</span>
                <span className="font-semibold text-gray-800">{formatCurrency(totals.cost)}</span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-gray-600">ë°°ì†¡ë¹„</span>
                <span className="font-semibold text-gray-800">{formatCurrency(totals.shippingFee)}</span>
              </div>
              <div className="flex justify-between font-bold text-lg border-t-2 border-indigo-300 pt-2 mt-2">
                <span className="text-gray-800">ë§ˆì§„</span>
                <span className="text-green-600">{formatCurrency(totals.margin)}</span>
              </div>
            </div>
          </div>
          
          {/* íŒë§¤ìˆ˜ëŸ‰ ì •ë³´ */}
          <div className="bg-white/60 p-4 rounded-lg">
            <p className="font-bold mb-3 text-purple-700 flex items-center gap-2">
              <Package className="h-4 w-4" />
              {year}ë…„ ëˆ„ì  íŒë§¤ìˆ˜ëŸ‰
            </p>
            <div className="space-y-2">
              {Object.entries(productSales).map(([product, qty]) => (
                <div key={product} className="flex justify-between text-sm">
                  <span className="text-gray-600">{product}</span>
                  <span className="font-semibold text-gray-800">{formatNumber(qty)}</span>
                </div>
              ))}
              <div className="flex justify-between font-bold text-lg border-t-2 border-purple-300 pt-2 mt-2">
                <span className="text-gray-800">ì´ìˆ˜ëŸ‰</span>
                <span className="text-purple-600">{formatNumber(totalProducts)}</span>
              </div>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}

// KPI ì„¤ì • ë‹¤ì´ì–¼ë¡œê·¸
function KPISettingsDialog({
  open,
  onOpenChange,
  settings,
  onSave,
}: {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  settings: KPISettings;
  onSave: (settings: KPISettings) => void;
}) {
  const [localSettings, setLocalSettings] = useState<KPISettings>(settings);

  useEffect(() => {
    setLocalSettings(settings);
  }, [settings]);

  const handlePartnerChange = (partner: string, field: 'supplyPrice' | 'costPrice' | 'enabled', value: number | boolean) => {
    setLocalSettings(prev => ({
      ...prev,
      partners: {
        ...prev.partners,
        [partner]: {
          ...prev.partners[partner],
          [field]: value,
        },
      },
    }));
  };

  const handleSave = () => {
    onSave(localSettings);
    onOpenChange(false);
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-4xl max-h-[80vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="text-2xl flex items-center gap-2">
            <Settings className="h-6 w-6 text-blue-600" />
            KPI ì„¤ì •
          </DialogTitle>
          <DialogDescription>
            í†µí•©ëŒ€ì‹œë³´ë“œì˜ KPI ê³„ì‚°ì„ ìœ„í•œ ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-6 py-4">
          {/* í˜‘ë ¥ì‚¬ë³„ ë‹¨ê°€ ì„¤ì • */}
          <div className="space-y-4">
            <h3 className="text-lg font-semibold text-gray-800 border-b pb-2">í˜‘ë ¥ì‚¬ë³„ ë‹¨ê°€ ì„¤ì •</h3>
            <div className="grid gap-4">
              {Object.entries(localSettings.partners).map(([partner, config]) => (
                <Card key={partner} className="p-4">
                  <div className="flex items-center gap-4">
                    <div className="flex-1">
                      <Label className="font-semibold text-base">{partner}</Label>
                    </div>
                    <div className="flex gap-4 items-center">
                      <div className="space-y-1">
                        <Label className="text-sm">ê³µê¸‰ê°€ (ì›/ê°œ)</Label>
                        <Input
                          type="number"
                          value={config.supplyPrice}
                          onChange={(e) => handlePartnerChange(partner, 'supplyPrice', Number(e.target.value))}
                          className="w-32"
                        />
                      </div>
                      <div className="space-y-1">
                        <Label className="text-sm">ì›ê°€ (ì›/ê°œ)</Label>
                        <Input
                          type="number"
                          value={config.costPrice}
                          onChange={(e) => handlePartnerChange(partner, 'costPrice', Number(e.target.value))}
                          className="w-32"
                        />
                      </div>
                      <div className="flex items-center gap-2 pt-6">
                        <input
                          type="checkbox"
                          checked={config.enabled}
                          onChange={(e) => handlePartnerChange(partner, 'enabled', e.target.checked)}
                          className="w-4 h-4"
                        />
                        <Label className="text-sm">í™œì„±í™”</Label>
                      </div>
                    </div>
                  </div>
                </Card>
              ))}
            </div>
          </div>

          {/* ë§ˆì§„ ê³„ì‚° ê³µì‹ */}
          <div className="space-y-4">
            <h3 className="text-lg font-semibold text-gray-800 border-b pb-2">ë§ˆì§„ ê³„ì‚° ê³µì‹</h3>
            <div className="space-y-2">
              <Label>ê³µì‹ (ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜: supplyPrice, costPrice, commission)</Label>
              <Textarea
                value={localSettings.marginFormula}
                onChange={(e) => setLocalSettings(prev => ({ ...prev, marginFormula: e.target.value }))}
                placeholder="supplyPrice - costPrice - commission"
                className="font-mono"
                rows={3}
              />
              <p className="text-sm text-gray-500">
                ê¸°ë³¸ ê³µì‹: ê³µê¸‰ê°€ - ì›ê°€ - ìˆ˜ìˆ˜ë£Œ
              </p>
            </div>
          </div>

          {/* ê¸°íƒ€ ì„¤ì • */}
          <div className="space-y-4">
            <h3 className="text-lg font-semibold text-gray-800 border-b pb-2">ê¸°íƒ€ ì„¤ì •</h3>
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>ë¶€ê°€ì„¸ìœ¨ (%)</Label>
                <Input
                  type="number"
                  step="0.1"
                  value={localSettings.vatRate * 100}
                  onChange={(e) => setLocalSettings(prev => ({ ...prev, vatRate: Number(e.target.value) / 100 }))}
                />
              </div>
              <div className="space-y-2">
                <Label>ìˆ˜ìˆ˜ë£Œìœ¨ (%)</Label>
                <Input
                  type="number"
                  step="0.1"
                  value={localSettings.commissionRate * 100}
                  onChange={(e) => setLocalSettings(prev => ({ ...prev, commissionRate: Number(e.target.value) / 100 }))}
                />
              </div>
            </div>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            ì·¨ì†Œ
          </Button>
          <Button onClick={handleSave} className="bg-blue-600 hover:bg-blue-700">
            ì €ì¥
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

// ============================================================================
// Main Component
// ============================================================================

export default function IntegratedDashboardPage() {
  const { data: session, status } = useSession();
  const [data, setData] = useState<DashboardData | null>(null);
  const [loading, setLoading] = useState(true);
  
  // ë‚ ì§œ ìƒíƒœ (ê¸°ë³¸ê°’: ì˜¤ëŠ˜)
  const today = new Date().toISOString().split('T')[0];
  const [startDate, setStartDate] = useState(today);
  const [endDate, setEndDate] = useState(today);

  // KPI ì„¤ì • ìƒíƒœ
  const [kpiSettingsOpen, setKpiSettingsOpen] = useState(false);
  const [kpiSettings, setKpiSettings] = useState<KPISettings>({
    partners: {
      "ë³¸ì‚¬": { supplyPrice: 45000, costPrice: 42000, enabled: true },
      "ë¡œì¼“ê·¸ë¡œìŠ¤": { supplyPrice: 92727.2, costPrice: 42000, enabled: true },
      "ê·¸ë¡œíŠ¸": { supplyPrice: 99000, costPrice: 42000, enabled: true },
      "ìŠ¤ëª°ë‹·": { supplyPrice: 99000, costPrice: 42000, enabled: true },
      "í•´í”¼í¬ì¦ˆ": { supplyPrice: 99000, costPrice: 42000, enabled: true },
    },
    marginFormula: "supplyPrice - costPrice - commission",
    vatRate: 0.1,
    commissionRate: 0,
  });

  // KPI ì„¤ì • ë¡œë“œ
  useEffect(() => {
    const savedSettings = localStorage.getItem('kpiSettings');
    if (savedSettings) {
      setKpiSettings(JSON.parse(savedSettings));
    }
  }, []);

  // KPI ì„¤ì • ì €ì¥
  const handleSaveKPISettings = (newSettings: KPISettings) => {
    setKpiSettings(newSettings);
    localStorage.setItem('kpiSettings', JSON.stringify(newSettings));
    // ì„¤ì • ë³€ê²½ ì‹œ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
    fetchData(startDate, endDate);
  };

  const fetchData = async (start?: string, end?: string) => {
    setLoading(true);
    try {
      const queryParams = new URLSearchParams({
        startDate: start || startDate,
        endDate: end || endDate,
        kpiSettings: JSON.stringify(kpiSettings), // KPI ì„¤ì • ì „ë‹¬
      });
      
      const response = await fetch(`/api/performance/integrated-dashboard?${queryParams}`);
      if (response.ok) {
        const result = await response.json();
        if (result.success) {
          setData(result.data);
        }
      }
    } catch (error) {
      console.error("Failed to fetch dashboard data:", error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, [kpiSettings]); // kpiSettings ë³€ê²½ ì‹œì—ë„ ë°ì´í„° ì¬ë¡œë“œ

  const handleSearch = () => {
    fetchData(startDate, endDate);
  };

  const handleReset = () => {
    const todayDate = new Date().toISOString().split('T')[0];
    setStartDate(todayDate);
    setEndDate(todayDate);
    fetchData(todayDate, todayDate);
  };

  // ì„¸ì…˜ ë¡œë”© ì¤‘
  if (status === "loading") {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
        <div className="text-center">
          <div className="relative">
            <div className="h-20 w-20 rounded-full border-t-4 border-b-4 border-blue-600 animate-spin mx-auto"></div>
            <div className="absolute top-0 left-1/2 transform -translate-x-1/2 h-20 w-20 rounded-full border-r-4 border-l-4 border-indigo-600 animate-spin animation-delay-150"></div>
          </div>
          <p className="mt-6 text-lg text-gray-600 font-medium animate-pulse">ì¸ì¦ í™•ì¸ ì¤‘...</p>
        </div>
      </div>
    );
  }

  // ê¶Œí•œ ì²´í¬ - ADMINë§Œ ì ‘ê·¼ ê°€ëŠ¥
  const userRole = (session?.user as { role?: string })?.role;
  if (userRole !== "ADMIN") {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
        <Card className="max-w-md w-full shadow-2xl border-red-200">
          <CardHeader className="bg-gradient-to-r from-red-50 to-orange-50 border-b border-red-100">
            <div className="flex items-center gap-3">
              <div className="p-3 bg-red-100 rounded-full">
                <ShieldAlert className="h-8 w-8 text-red-600" />
              </div>
              <div>
                <CardTitle className="text-2xl font-bold text-red-700">ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ</CardTitle>
                <p className="text-sm text-red-600 mt-1">Access Denied</p>
              </div>
            </div>
          </CardHeader>
          <CardContent className="p-8 text-center space-y-4">
            <p className="text-gray-700 text-lg">
              í†µí•©ëŒ€ì‹œë³´ë“œëŠ” <span className="font-bold text-red-600">ê´€ë¦¬ì ì „ìš©</span> í˜ì´ì§€ì…ë‹ˆë‹¤.
            </p>
            <p className="text-gray-500 text-sm">
              ì´ í˜ì´ì§€ì— ì ‘ê·¼í•˜ë ¤ë©´ ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
            </p>
            <div className="pt-4">
              <Button 
                onClick={() => window.history.back()}
                className="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700"
              >
                ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      </div>
    );
  }

  if (!data) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <p className="text-gray-600">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    );
  }

  const displayDate = data.dateRange?.startDate === data.dateRange?.endDate
    ? `${data.dateRange.startDate.replace(/-/g, '.')}` 
    : `${data.dateRange?.startDate.replace(/-/g, '.')} ~ ${data.dateRange?.endDate.replace(/-/g, '.')}`;

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 p-6 space-y-8">
      {/* í˜„ëŒ€ì ì¸ í—¤ë” */}
      <div className="flex justify-between items-center bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-100">
        <div className="space-y-2">
          <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
            í†µí•©ëŒ€ì‹œë³´ë“œ
          </h1>
          <p className="text-gray-600 text-lg flex items-center gap-2">
            <BarChart2 className="h-5 w-5" />
            {displayDate} ê¸°ì¤€ ì‹¤ì‹œê°„ ì„±ê³¼ í˜„í™©
          </p>
        </div>

        {/* KPI ì„¤ì • ë²„íŠ¼ */}
        <Button
          onClick={() => setKpiSettingsOpen(true)}
          variant="outline"
          className="shadow-md hover:shadow-lg transition-all duration-300 bg-white"
        >
          <Settings className="mr-2 h-4 w-4" />
          KPI ì„¤ì •
        </Button>
        
        {/* ë‚ ì§œ ê²€ìƒ‰ */}
        <Card className="shadow-xl border-0 bg-gradient-to-br from-white to-blue-50">
          <CardContent className="p-6">
            <div className="flex items-center gap-4">
              <div>
                <label className="text-sm font-semibold mb-2 block text-gray-700 flex items-center gap-1">
                  <Calendar className="h-4 w-4" />
                  ì‹œì‘ì¼
                </label>
                <Input 
                  type="date" 
                  value={startDate}
                  onChange={(e) => setStartDate(e.target.value)}
                  className="w-44 shadow-sm border-gray-200"
                />
              </div>
              <div className="pt-6 text-gray-400 font-bold">â†’</div>
              <div>
                <label className="text-sm font-semibold mb-2 block text-gray-700 flex items-center gap-1">
                  <Calendar className="h-4 w-4" />
                  ì¢…ë£Œì¼
                </label>
                <Input 
                  type="date" 
                  value={endDate}
                  onChange={(e) => setEndDate(e.target.value)}
                  className="w-44 shadow-sm border-gray-200"
                />
              </div>
              <div className="flex gap-2 pt-6">
                <Button 
                  onClick={handleSearch}
                  disabled={loading}
                  className="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 shadow-lg hover:shadow-xl transition-all duration-300"
                >
                  <Search className="mr-2 h-4 w-4" />
                  ì¡°íšŒ
                </Button>
                <Button 
                  onClick={handleReset}
                  disabled={loading}
                  variant="outline"
                  className="shadow-md hover:shadow-lg transition-all duration-300"
                >
                  <RefreshCcw className="mr-2 h-4 w-4" />
                  ì˜¤ëŠ˜
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Row 1: ì„ íƒ ê¸°ê°„ í†µê³„ */}
      <div className="space-y-4">
        <div className="flex items-center gap-3">
          <div className="h-8 w-1 bg-gradient-to-b from-blue-600 to-indigo-600 rounded-full"></div>
          <h2 className="text-2xl font-bold text-gray-800">ì„ íƒ ê¸°ê°„ ë§¤ì¶œ í˜„í™©</h2>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          <DailySalesCard
            title={`ì´ ë§¤ì¶œ (${displayDate})`}
            data={data.today.byPartner}
            totals={data.today.totals}
            icon={TrendingUp}
            excludeRocketGrowth={true}
          />
          <OrderCountCard
            title="ì£¼ë¬¸ ê±´ìˆ˜"
            data={data.today.byPartner}
            totals={data.today.totals}
          />
          <SupplyPriceCard
            title="ê³µê¸‰ê°€"
            data={data.today.byPartner}
            totals={data.today.totals}
            excludeRocketGrowth={true}
          />
          <ShippingFeeCard
            title="ë°°ì†¡ë¹„"
            data={data.today.byPartner}
            totals={data.today.totals}
            excludeRocketGrowth={true}
          />
        </div>
      </div>

      {/* Row 2: 1~í˜„ì¬ ëˆ„ê³„ */}
      <div className="space-y-4">
        <div className="flex items-center gap-3">
          <div className="h-8 w-1 bg-gradient-to-b from-emerald-600 to-teal-600 rounded-full"></div>
          <h2 className="text-2xl font-bold text-gray-800">1ì¼~í˜„ì¬ ëˆ„ê³„</h2>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          <DailySalesCard
            title="1~í˜„ì¬ ì¼ ì´ ë§¤ì¶œ(ë³¸ì‚¬,íŒŒíŠ¸ë„ˆë“¤ í¬í•¨)"
            data={data.month.byPartner}
            totals={data.month.totals}
            icon={TrendingUp}
            bgColor="bg-gradient-to-br from-emerald-50 to-teal-50"
            borderColor="border-emerald-300"
            excludeRocketGrowth={true}
          />
          <OrderCountCard
            title="1~í˜„ì¬ ì¼ ê±´ìˆ˜"
            data={data.month.byPartner}
            totals={data.month.totals}
          />
          <SupplyPriceCard
            title="ê³µê¸‰ê°€"
            data={data.month.byPartner}
            totals={data.month.totals}
            excludeRocketGrowth={true}
          />
          <ShippingFeeCard
            title="1~í˜„ì¬ ë°°ì†¡ë¹„"
            data={data.month.byPartner}
            totals={data.month.totals}
            excludeRocketGrowth={true}
          />
        </div>
      </div>

      {/* Row 3: ë§ˆì§„, ì „ì›”, ëˆ„ì  */}
      <div className="space-y-4">
        <div className="flex items-center gap-3">
          <div className="h-8 w-1 bg-gradient-to-b from-purple-600 to-pink-600 rounded-full"></div>
          <h2 className="text-2xl font-bold text-gray-800">ë§ˆì§„ ë° ëˆ„ì  í†µê³„</h2>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          <MarginCard
            title="1~í˜„ì¬ ì¼ ì´(ì—…ì²´ì´) ë§ˆì§„ê¸ˆì•¡"
            totals={data.month.totals}
          />
          <LastMonthCard data={data.lastMonth} />
          <YearAccumulatedCard
            totals={data.year.totals}
            productSales={data.year.productSales}
            year={data.dateRange.year}
          />
        </div>
      </div>

      {/* ê³„ì‚° ê¸°ì¤€ ì •ë³´ */}
      <Card className="bg-gradient-to-br from-gray-50 to-slate-100 border-gray-200 shadow-lg">
        <CardHeader className="pb-3">
          <CardTitle className="text-sm font-semibold flex items-center gap-2 text-gray-700">
            <div className="p-2 bg-white rounded-lg shadow-sm">
              ğŸ“Œ
            </div>
            ê³„ì‚° ê¸°ì¤€
          </CardTitle>
        </CardHeader>
        <CardContent className="text-sm text-gray-600 grid grid-cols-2 md:grid-cols-4 gap-4 bg-white/60 p-4 rounded-lg">
          <div>
            <span className="font-medium">ê³µê¸‰ê°€:</span> ì‰´ë“œ ìˆ˜ëŸ‰ Ã— {formatNumber(data.priceInfo.supplyPricePerUnit)}ì›
          </div>
          <div>
            <span className="font-medium">ë¶€ê°€ì„¸:</span> ê³µê¸‰ê°€ Ã— {data.priceInfo.vatRate * 100}%
          </div>
          <div>
            <span className="font-medium">ì›ê°€:</span> ì‰´ë“œ 1ê°œë‹¹ {formatNumber(data.priceInfo.costPerUnit)}ì›
          </div>
          <div>
            <span className="font-medium">ë§ˆì§„:</span> ê³µê¸‰ê°€ - ì›ê°€ - ìˆ˜ìˆ˜ë£Œ(0)
          </div>
        </CardContent>
      </Card>

      {/* KPI ì„¤ì • ë‹¤ì´ì–¼ë¡œê·¸ */}
      <KPISettingsDialog
        open={kpiSettingsOpen}
        onOpenChange={setKpiSettingsOpen}
        settings={kpiSettings}
        onSave={handleSaveKPISettings}
      />
    </div>
  );
}
